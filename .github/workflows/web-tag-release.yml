name: Web Tag, Release & Deploy

on:
  pull_request_target:
    branches:
      - main
    types: [closed]
    paths:
      - apps/web/**
      - packages/**

jobs:
  tag-release-deploy:
    if: github.event.pull_request.merged == true
    permissions:
      attestations: write
      contents: write
      id-token: write
      pull-requests: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          NEW_VERSION=$(node -p 'require("./apps/web/package.json").version')
          echo "version=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create a git tag
        if: steps.version.outputs.version
        run: git tag ${{ steps.version.outputs.version }} && git push --tags

      - name: Extract changelog from PR body
        id: extract_changelog
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Extract only the changelog section from the PR body
          # Remove everything from "## üìã QA Checklist" onwards
          # Using environment variable to avoid code injection

          # Extract content between release header and QA checklist
          CHANGELOG=$(echo "$PR_BODY" | sed -n '/^## üöÄ Release/,/^## üìã QA Checklist/p' | sed '$d')

          # Save to output
          {
            echo 'changelog<<CHANGELOG_EOF'
            echo "$CHANGELOG"
            echo 'CHANGELOG_EOF'
          } >> $GITHUB_OUTPUT

      - name: Create GitHub release (draft)
        if: steps.version.outputs.version
        uses: softprops/action-gh-release@v2
        id: create_release
        with:
          draft: true
          prerelease: false
          name: ${{ steps.version.outputs.version }}
          tag_name: ${{ steps.version.outputs.version }}
          body: |
            ${{ steps.extract_changelog.outputs.changelog }}

            [üîó IPFS release](
            https://github.com/5afe/safe-wallet-ipfs/releases/tag/${{ steps.version.outputs.version }})
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - uses: ./.github/actions/yarn

      - uses: ./.github/actions/build
        with:
          secrets: ${{ toJSON(secrets) }}
          prod: ${{ true }}

      - name: Add SRI to scripts
        run: node ./scripts/integrity-hashes.cjs
        working-directory: apps/web

      - name: Create archive
        run: tar -czf "${{ github.event.repository.name }}-${{ steps.version.outputs.version }}".tar.gz out
        working-directory: apps/web

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: apps/web/${{ github.event.repository.name }}-${{ steps.version.outputs.version }}.tar.gz

      - name: Create checksum
        run: sha256sum "${{ github.event.repository.name }}-${{ steps.version.outputs.version }}".tar.gz > "${{ github.event.repository.name }}-${{ steps.version.outputs.version }}-sha256-checksum.txt"
        working-directory: apps/web

      - name: Upload archive as release asset
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: apps/web/${{ github.event.repository.name }}-${{ steps.version.outputs.version }}.tar.gz

      - name: Upload checksum as release asset
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: apps/web/${{ github.event.repository.name }}-${{ steps.version.outputs.version }}-sha256-checksum.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Script to upload release files
      - name: Upload release build files for production
        env:
          BUCKET: s3://${{ secrets.AWS_STAGING_BUCKET_NAME }}/releases/${{ steps.version.outputs.version }}
          CHECKSUM_FILE: ${{ github.event.repository.name }}-${{ steps.version.outputs.version }}-sha256-checksum.txt
        run: bash ./scripts/github/s3_upload.sh
        working-directory: apps/web

      # Script to prepare production deployments
      - name: Prepare deployment
        run: bash ./scripts/github/prepare_production_deployment.sh
        working-directory: apps/web
        env:
          PROD_DEPLOYMENT_HOOK_TOKEN: ${{ secrets.PROD_DEPLOYMENT_HOOK_TOKEN }}
          PROD_DEPLOYMENT_HOOK_URL: ${{ secrets.PROD_DEPLOYMENT_HOOK_URL }}
          VERSION_TAG: ${{ steps.version.outputs.version }}

      - name: Create back-merge PR
        continue-on-error: true
        id: backmerge
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.version }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch latest changes
          git fetch origin main dev

          # Create a branch for the back-merge PR
          BRANCH_NAME="backmerge/main-to-dev-${VERSION}"
          git checkout -B "$BRANCH_NAME" origin/dev

          # Attempt to merge main into the branch
          if git merge origin/main -m "chore: back-merge main to dev after release ${VERSION}"; then
            git push origin "$BRANCH_NAME"

            # Create PR body file to avoid shell interpolation issues
            cat > /tmp/pr-body.md << EOF
          ## Back-merge from main

          This PR syncs changes from \`main\` back to \`dev\` after release ${VERSION}.

          ‚úÖ Clean merge - no conflicts detected.

          ü§ñ *Created automatically by [Tag Release workflow](https://github.com/${REPO}/actions/runs/${RUN_ID})*
          EOF

            PR_URL=$(gh pr create \
              --base dev \
              --head "$BRANCH_NAME" \
              --title "üîÑ Back-merge main to dev after ${VERSION}" \
              --body-file /tmp/pr-body.md \
              | tail -n 1)

            echo "‚úÖ Back-merge PR created: $PR_URL"
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            # Merge failed due to conflicts - abort and create PR with conflict note
            git merge --abort
            git checkout -B "$BRANCH_NAME" origin/dev
            git push origin "$BRANCH_NAME"

            # Create PR body file to avoid shell interpolation issues
            cat > /tmp/pr-body.md << EOF
          ## ‚ö†Ô∏è Back-merge from main - CONFLICTS DETECTED

          This PR syncs changes from \`main\` back to \`dev\` after release ${VERSION}.

          **Action Required:** Please resolve merge conflicts manually by merging \`main\` into this branch.

          \`\`\`bash
          git fetch origin
          git checkout ${BRANCH_NAME}
          git merge origin/main
          # Resolve conflicts
          git push
          \`\`\`

          ü§ñ *Created automatically by [Tag Release workflow](https://github.com/${REPO}/actions/runs/${RUN_ID})*
          EOF

            PR_URL=$(gh pr create \
              --base dev \
              --head "$BRANCH_NAME" \
              --title "üîÑ Back-merge main to dev after ${VERSION} (CONFLICTS)" \
              --body-file /tmp/pr-body.md \
              | tail -n 1)

            echo "Back-merge PR created with conflicts: $PR_URL"
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish GitHub release
        if: steps.version.outputs.version && success()
        run: gh release edit ${{ steps.version.outputs.version }} --draft=false
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Notify on Slack
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "No Slack webhook configured, skipping notification"
            exit 0
          fi

          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          BACKMERGE_PR_URL="${{ steps.backmerge.outputs.pr_url }}"
          HAS_CONFLICTS="${{ steps.backmerge.outputs.has_conflicts }}"

          if [ -n "$BACKMERGE_PR_URL" ]; then
            if [ "$HAS_CONFLICTS" = "true" ]; then
              BACKMERGE_MSG="üîÑ <$BACKMERGE_PR_URL|Back-merge PR> created (conflicts need resolution)"
            else
              BACKMERGE_MSG="üîÑ <$BACKMERGE_PR_URL|Back-merge PR> created - please review and merge"
            fi
          else
            BACKMERGE_MSG="_‚ö†Ô∏è Back-merge PR creation failed - manual action needed_"
          fi

          jq -n \
            --arg version "$VERSION" \
            --arg url "$RELEASE_URL" \
            --arg backmerge "$BACKMERGE_MSG" \
            '{
              channel: "#topic-wallet-releases",
              text: ("‚úÖ Safe Wallet " + $version + " ready for going live"),
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: ("*Safe Wallet " + $version + " is ready for going live* ‚úÖ\n\n<" + $url + "|View Release on GitHub>\n\n" + $backmerge)
                  }
                }
              ]
            }' | curl -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d @-
